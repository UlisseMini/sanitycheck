generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// Core Data Models
// =====================================================

model Article {
  id          String    @id @default(cuid())
  createdAt   DateTime  @default(now())
  
  url         String
  title       String?
  textContent String    // Full article text we analyzed
  textHash    String    // Hash of textContent for deduplication
  
  ip          String?
  userAgent   String?
  
  analyses    Analysis[]
  comments    Comment[]
  
  @@unique([url, textHash])
  @@index([url])
  @@index([createdAt])
  @@index([ip])
}

model Analysis {
  id           String      @id @default(cuid())
  createdAt    DateTime    @default(now())
  
  articleId    String
  article      Article     @relation(fields: [articleId], references: [id], onDelete: Cascade)
  
  modelVersion String?     // e.g., "claude-4.5-sonnet"
  rawResponse  Json        // Full model output for debugging/replay
  severity     String?     // none/minor/moderate/significant
  
  // Prompt tracking
  promptUsed   String?     // Full prompt used for this analysis
  isCustomPrompt Boolean   @default(false)  // True if user modified the default
  
  highlights   Highlight[]
  
  @@index([articleId])
  @@index([createdAt])
}

model Highlight {
  id         String   @id @default(cuid())
  
  analysisId String
  analysis   Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  
  quote      String
  importance String   // critical/significant/minor
  gap        String
  
  @@index([analysisId])
  @@index([importance])
}

model Comment {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  
  articleId    String
  article      Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  
  selectedText String   // What they highlighted
  commentText  String   // Their feedback
  
  ip           String?
  userAgent    String?
  
  @@index([articleId])
  @@index([createdAt])
}

// =====================================================
// Legacy & Utility Models
// =====================================================

// DEPRECATED: Use Comment instead. Kept for data migration.
model Annotation {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  url         String
  title       String?
  quote       String
  annotation  String
  fallacyType String?
  userId      String?
  userAgent   String?
  
  @@index([url])
  @@index([fallacyType])
  @@index([createdAt])
}

model DebugLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  level     String
  message   String
  data      Json?
  source    String?
  ip        String?
  version   String?
  userAgent String?
  
  @@index([createdAt])
  @@index([ip])
  @@index([level])
}
